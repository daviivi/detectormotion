<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
  <title>Motion Detector - Detec√ß√£o de Movimento</title>
  
  <!-- iOS Safari specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Motion Detector">
  <meta name="apple-touch-fullscreen" content="yes">
  
  <!-- Android Chrome specific -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e3a8a">
  <meta name="msapplication-navbutton-color" content="#1e3a8a">
  
  <!-- Prevent zoom on input focus -->
  <meta name="format-detection" content="telephone=no">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  
  <script>
    // Global variables
    let capture;
    let video;
    let previousFrame;
    let motionThreshold = 25;
    let currentSource = 'webcam';
    let isVideoPlaying = false;
    let uploadedVideo = null;
    let canvasWidth = 320;
    let canvasHeight = 240;
    let isAppStarted = false;
    let cameraPermissionDenied = false;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    let cameraAttempts = 0;
    let maxCameraAttempts = 3;
    let mediaStream = null;
    let motionBoxes = [];

    // Check if HTTPS is required
    function checkHTTPS() {
      const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const isHTTPS = location.protocol === 'https:';
      
      if (!isLocalhost && !isHTTPS) {
        updateStatus('‚ö†Ô∏è HTTPS necess√°rio para c√¢mera', 'error');
        showHTTPSError();
        return false;
      }
      return true;
    }

    // Start the application
    window.startApp = function() {
      if (!checkHTTPS()) {
        return;
      }
      
      const welcomeScreen = document.getElementById('welcomeScreen');
      welcomeScreen.classList.add('hidden');
      isAppStarted = true;
      
      setTimeout(() => {
        welcomeScreen.style.display = 'none';
        initializeApp();
      }, 500);
    };

    // Switch between camera and video upload
    window.switchSource = function(source) {
      currentSource = source;
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`${source}-tab`).classList.add('active');
      
      const uploadSection = document.getElementById('video-upload-section');
      const videoControls = document.getElementById('video-controls');
      
      if (source === 'video') {
        uploadSection.style.display = 'block';
        videoControls.style.display = 'none';
        updateStatus('üìÅ Fa√ßa upload de um v√≠deo para come√ßar', 'loading');
        stopCamera();
      } else {
        uploadSection.style.display = 'none';
        videoControls.style.display = 'none';
        if (!cameraPermissionDenied && checkHTTPS()) {
          initializeWebcam();
        } else {
          updateStatus('‚ùå C√¢mera n√£o dispon√≠vel', 'error');
          showCameraHelp();
        }
      }
      
      clearErrorMessage();
    };

    // Stop camera stream properly
    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => {
          track.stop();
        });
        mediaStream = null;
      }
      
      if (capture) {
        capture.remove();
        capture = null;
      }
    }

    // Handle video upload
    window.handleVideoUpload = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('video/')) {
        showErrorMessage('‚ö†Ô∏è Por favor, selecione um arquivo de v√≠deo v√°lido.');
        return;
      }
      
      updateStatus('‚è≥ Carregando v√≠deo...', 'loading');
      clearErrorMessage();
      stopCamera();
      
      try {
        if (uploadedVideo) {
          uploadedVideo.remove();
        }
        
        uploadedVideo = createVideo(URL.createObjectURL(file));
        uploadedVideo.size(canvasWidth, canvasHeight);
        uploadedVideo.hide();
        
        uploadedVideo.elt.addEventListener('loadeddata', () => {
          updateStatus('‚úÖ V√≠deo carregado - Pressione Play', 'ready');
          document.getElementById('video-controls').style.display = 'flex';
        });
        
        uploadedVideo.elt.addEventListener('ended', () => {
          isVideoPlaying = false;
          updatePlayPauseButton();
          updateStatus('üèÅ V√≠deo finalizado', 'ready');
        });
        
        uploadedVideo.elt.addEventListener('error', () => {
          showErrorMessage('‚ùå Erro ao carregar v√≠deo. Tente outro formato.');
        });
        
      } catch (error) {
        console.error('Video loading failed:', error);
        showErrorMessage('‚ùå Erro ao carregar v√≠deo. Tente outro formato.');
      }
    };

    // Video controls
    window.togglePlayPause = function() {
      if (!uploadedVideo) return;
      
      if (isVideoPlaying) {
        uploadedVideo.pause();
        isVideoPlaying = false;
        updateStatus('‚è∏Ô∏è V√≠deo pausado', 'ready');
      } else {
        uploadedVideo.play();
        isVideoPlaying = true;
        updateStatus('‚ñ∂Ô∏è Reproduzindo - Detectando movimento...', 'ready');
      }
      
      updatePlayPauseButton();
    };

    window.restartVideo = function() {
      if (!uploadedVideo) return;
      
      uploadedVideo.time(0);
      if (isVideoPlaying) {
        uploadedVideo.play();
      }
      updateStatus('üîÑ V√≠deo reiniciado', 'ready');
    };

    // Initialize application
    function initializeApp() {
      updateStatus('üöÄ Inicializando...', 'loading');
      adjustCanvasSize();
      
      setTimeout(() => {
        if (currentSource === 'webcam') {
          initializeWebcam();
        }
      }, 1000);
    }

    // Adjust canvas size for mobile
    function adjustCanvasSize() {
      const containerWidth = Math.min(window.innerWidth - 40, 600);
      const aspectRatio = 4/3;
      
      canvasWidth = containerWidth;
      canvasHeight = Math.floor(containerWidth / aspectRatio);
      
      // Ensure minimum usable size
      if (canvasWidth < 240) {
        canvasWidth = 240;
        canvasHeight = 180;
      }
      
      // Maximum size for performance
      if (canvasWidth > 480) {
        canvasWidth = 480;
        canvasHeight = 360;
      }
    }

    // Update status display
    function updateStatus(message, type = 'loading') {
      const statusElement = document.getElementById('status');
      statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${message}`;
    }

    // Initialize webcam with robust error handling
    async function initializeWebcam() {
      if (cameraAttempts >= maxCameraAttempts) {
        cameraPermissionDenied = true;
        updateStatus('‚ùå Muitas tentativas falhas', 'error');
        showCameraHelp();
        return;
      }
      
      cameraAttempts++;
      updateStatus('üìπ Solicitando acesso √† c√¢mera...', 'loading');
      showCameraPermissionGuide();
      stopCamera();
      
      try {
        // Check if getUserMedia is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('getUserMedia n√£o suportado');
        }
        
        // Mobile-optimized constraints
        const constraints = {
          video: {
            width: { ideal: canvasWidth, max: 640 },
            height: { ideal: canvasHeight, max: 480 },
            facingMode: isMobile ? 'environment' : 'user',
            frameRate: { ideal: 15, max: 20 }
          },
          audio: false
        };
        
        // For iOS, try simplified constraints first
        if (isIOS && cameraAttempts === 1) {
          constraints.video = {
            facingMode: 'environment',
            width: { max: 480 },
            height: { max: 360 }
          };
        }
        
        // Get media stream first
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Create p5.js capture from stream
        capture = createCapture(VIDEO, (stream) => {
          console.log('Camera initialized successfully');
          updateStatus('‚úÖ C√¢mera ativa - Detectando movimento...', 'ready');
          clearErrorMessage();
          cameraPermissionDenied = false;
          cameraAttempts = 0; // Reset on success
        });
        
        capture.size(canvasWidth, canvasHeight);
        capture.hide();
        
        // Additional checks for mobile
        setTimeout(() => {
          if (capture && capture.elt) {
            if (capture.elt.videoWidth > 0 && capture.elt.videoHeight > 0) {
              updateStatus('‚úÖ C√¢mera funcionando perfeitamente!', 'ready');
              clearErrorMessage();
            } else {
              // Try again with different constraints
              if (cameraAttempts < maxCameraAttempts) {
                setTimeout(initializeWebcam, 1000);
              }
            }
          }
        }, 3000);
        
      } catch (error) {
        console.error('Camera access failed:', error);
        handleCameraError(error);
      }
    }

    // Handle camera errors specifically
    function handleCameraError(error) {
      let errorMessage = '';
      
      switch(error.name) {
        case 'NotAllowedError':
          errorMessage = '‚ùå Permiss√£o negada pelo usu√°rio';
          cameraPermissionDenied = true;
          break;
        case 'NotFoundError':
          errorMessage = '‚ùå C√¢mera n√£o encontrada no dispositivo';
          cameraPermissionDenied = true;
          break;
        case 'NotReadableError':
          errorMessage = '‚ùå C√¢mera sendo usada por outro app';
          break;
        case 'OverconstrainedError':
          errorMessage = '‚ùå Configura√ß√µes n√£o suportadas';
          break;
        case 'SecurityError':
          errorMessage = '‚ùå HTTPS necess√°rio ou origem n√£o segura';
          break;
        default:
          errorMessage = `‚ùå Erro de c√¢mera: ${error.message}`;
          break;
      }
      
      updateStatus(errorMessage, 'error');
      
      // Try again with fallback constraints
      if (cameraAttempts < maxCameraAttempts && !cameraPermissionDenied) {
        setTimeout(() => {
          initializeWebcamFallback();
        }, 2000);
      } else {
        showCameraHelp();
      }
    }

    // Fallback camera initialization with minimal constraints
    async function initializeWebcamFallback() {
      try {
        updateStatus('üîÑ Tentando configura√ß√£o alternativa...', 'loading');
        
        const fallbackConstraints = {
          video: true, // Minimal constraints
          audio: false
        };
        
        mediaStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        
        capture = createCapture(VIDEO);
        capture.size(canvasWidth, canvasHeight);
        capture.hide();
        
        setTimeout(() => {
          if (capture && capture.elt && capture.elt.videoWidth > 0) {
            updateStatus('‚úÖ C√¢mera ativa (modo compatibilidade)', 'ready');
            clearErrorMessage();
            cameraPermissionDenied = false;
          }
        }, 2000);
        
      } catch (error) {
        handleCameraError(error);
      }
    }

    // Show camera permission guide
    function showCameraPermissionGuide() {
      const container = document.getElementById('error-container');
      container.innerHTML = `
        <div class="info-message">
          <div style="font-size: 2rem; margin-bottom: 10px;">üìπ</div>
          <h3 style="margin: 0 0 10px 0; color: #00ff88;">Acesso √† C√¢mera</h3>
          <p style="margin: 5px 0;">Quando solicitado, clique em <strong>"Permitir"</strong></p>
          ${isMobile ? 
            '<p style="margin: 5px 0; font-size: 0.9rem;">üì± No mobile: pode aparecer um popup ou √≠cone na barra</p>' : 
            '<p style="margin: 5px 0; font-size: 0.9rem;">üíª Procure o √≠cone de c√¢mera na barra de endere√ßos</p>'
          }
        </div>
      `;
    }

    // Show camera help with detailed instructions
    function showCameraHelp() {
      const container = document.getElementById('error-container');
      
      const mobileInstructions = `
        üì± <strong>Instru√ß√µes para Mobile:</strong><br>
        ‚Ä¢ Atualize a p√°gina e clique em "Permitir" na popup<br>
        ‚Ä¢ Verifique se outro app n√£o est√° usando a c√¢mera<br>
        ‚Ä¢ Tente fechar outras abas do navegador<br>
        ‚Ä¢ Use Chrome ou Safari (navegadores recomendados)<br>
        ‚Ä¢ Acesse via HTTPS se poss√≠vel<br>
        ‚Ä¢ Reinicie o navegador se necess√°rio<br><br>
      `;
      
      const desktopInstructions = `
        üíª <strong>Instru√ß√µes para Desktop:</strong><br>
        ‚Ä¢ Clique no √≠cone de c√¢mera na barra de endere√ßos<br>
        ‚Ä¢ Selecione "Sempre permitir" para este site<br>
        ‚Ä¢ Atualize a p√°gina ap√≥s permitir<br>
        ‚Ä¢ Verifique se outro programa n√£o est√° usando a c√¢mera<br><br>
      `;
      
      container.innerHTML = `
        <div class="error-message">
          <div style="font-size: 1.5rem; margin-bottom: 15px;">üö´ C√¢mera Inacess√≠vel</div>
          <div style="text-align: left; margin: 15px 0; font-size: 0.9rem; line-height: 1.4;">
            ${isMobile ? mobileInstructions : desktopInstructions}
            üé¨ <strong>Alternativa:</strong> Use "Upload V√≠deo" para testar a detec√ß√£o
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 15px;">
            <button onclick="window.location.reload()" class="help-button primary">
              üîÑ Recarregar P√°gina
            </button>
            <button onclick="window.switchSource('video')" class="help-button secondary">
              üé¨ Upload V√≠deo
            </button>
          </div>
        </div>
      `;
    }

    // Show HTTPS error
    function showHTTPSError() {
      const container = document.getElementById('error-container');
      container.innerHTML = `
        <div class="error-message">
          <div style="font-size: 1.5rem; margin-bottom: 15px;">üîí HTTPS Necess√°rio</div>
          <p>Para acessar a c√¢mera, este site precisa ser carregado via HTTPS.</p>
          <p><strong>Solu√ß√µes:</strong></p>
          <p>‚Ä¢ Execute localmente (localhost)</p>
          <p>‚Ä¢ Use um servidor HTTPS</p>
          <p>‚Ä¢ Ou teste com a op√ß√£o "Upload V√≠deo"</p>
          <button onclick="window.switchSource('video')" class="help-button secondary" style="margin-top: 15px;">
            üé¨ Usar Upload V√≠deo
          </button>
        </div>
      `;
    }

    // Utility functions
    function updatePlayPauseButton() {
      const btn = document.getElementById('play-pause-btn');
      btn.innerHTML = isVideoPlaying ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Play';
    }

    function showErrorMessage(message) {
      const container = document.getElementById('error-container');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function clearErrorMessage() {
      document.getElementById('error-container').innerHTML = '';
    }

    // Drag and drop functionality
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('upload-area');
      
      if (uploadArea) {
        ['dragover', 'dragenter'].forEach(eventName => {
          uploadArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
          });
        });
        
        uploadArea.addEventListener('drop', (e) => {
          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].type.startsWith('video/')) {
            const fileInput = document.getElementById('file-input');
            fileInput.files = files;
            window.handleVideoUpload({ target: { files: files } });
          } else {
            showErrorMessage('‚ö†Ô∏è Por favor, solte um arquivo de v√≠deo v√°lido.');
          }
        });
      }
    }

    // Handle orientation change and resize
    function handleOrientationChange() {
      setTimeout(() => {
        adjustCanvasSize();
        if (window.canvas) {
          resizeCanvas(canvasWidth, canvasHeight);
        }
      }, 500);
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
      setupDragAndDrop();
      
      if (isMobile) {
        window.addEventListener('orientationchange', handleOrientationChange);
        window.addEventListener('resize', handleOrientationChange);
        
        // Prevent bounce scrolling on iOS
        document.addEventListener('touchmove', function(e) {
          e.preventDefault();
        }, { passive: false });
      }
    });

    // p5.js functions
    function setup() {
      let canvas = createCanvas(canvasWidth, canvasHeight);
      canvas.parent('canvas-container');
      
      pixelDensity(1);
      frameRate(isMobile ? 12 : 25); // Optimized for mobile
      
      background(0);
      fill(255);
      textAlign(CENTER, CENTER);
      textSize(14);
      text('Aguardando inicializa√ß√£o...', width/2, height/2);
    }

    function draw() {
      if (!isAppStarted) {
        background(0);
        fill(255);
        textAlign(CENTER, CENTER);
        textSize(12);
        text('Pressione "Come√ßar"', width/2, height/2);
        return;
      }
      
      background(0);
      
      let currentFrame = getCurrentFrame();
      
      if (!currentFrame) {
        drawWaitingMessage();
        return;
      }
      
      // Display current frame
      image(currentFrame, 0, 0, width, height);
      
      // Motion detection (optimized)
      if (previousFrame && frameCount % (isMobile ? 8 : 4) === 0) {
        detectMotionBoxes(currentFrame);
      }
      
      // Draw motion boxes
      drawMotionBoxes();
      
      // Store frame for comparison
      if (frameCount % (isMobile ? 8 : 4) === 0) {
        previousFrame = currentFrame.get();
      }
    }

    function getCurrentFrame() {
      if (currentSource === 'webcam' && capture && capture.elt && capture.elt.videoWidth > 0) {
        return capture;
      } else if (currentSource === 'video' && uploadedVideo && uploadedVideo.elt && uploadedVideo.elt.videoWidth > 0) {
        return uploadedVideo;
      }
      return null;
    }

    function drawWaitingMessage() {
      fill(255);
      textAlign(CENTER, CENTER);
      textSize(12);
      
      if (currentSource === 'webcam' && cameraPermissionDenied) {
        text('C√¢mera n√£o dispon√≠vel\nTente "Upload V√≠deo"', width/2, height/2);
      } else {
        text('Aguardando fonte de v√≠deo...', width/2, height/2);
      }
    }

    function detectMotionBoxes(currentFrame) {
      if (!currentFrame || !previousFrame) return;
      
      currentFrame.loadPixels();
      previousFrame.loadPixels();
      
      let motionGrid = [];
      let gridSize = isMobile ? 20 : 16;
      let gridCols = Math.floor(currentFrame.width / gridSize);
      let gridRows = Math.floor(currentFrame.height / gridSize);
      
      // Initialize motion grid
      for (let x = 0; x < gridCols; x++) {
        motionGrid[x] = [];
        for (let y = 0; y < gridRows; y++) {
          motionGrid[x][y] = false;
        }
      }
      
      // Detect motion in grid cells
      for (let x = 0; x < gridCols; x++) {
        for (let y = 0; y < gridRows; y++) {
          let motion
